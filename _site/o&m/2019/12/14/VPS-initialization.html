<style>
  table{
    border-left:1px solid #000000;border-top:1px solid #000000;
    width: 100%;
    word-wrap:break-word; word-break:break-all;
  }
  table th{
  text-align:center;
  }
  table th,td{
    border-right:1px solid #000000;border-bottom:1px solid #000000;
  }
</style>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>zxz0</title>
	<link rel="icon" href="/blog/assets/images/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/blog/assets/js/jquery.min.js"></script>
    <script src="/blog/assets/js/bootstrap.min.js"></script>
    <link href="/blog/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/blog/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!--[if IE 7]>
    <link rel="stylesheet" href="assets/css/font-awesome-ie7.min.css">
    <![endif]-->
    <!--[if lt IE 9]>
       <script src="https://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
       <script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.js"></script>
    <![endif]-->
    <link href="/blog/assets/css/main.css" rel="stylesheet" type="text/css">


</head>

<body>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="navbar navbar-custom navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/blog/">zxz0</a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    
                    <li class="active"><a href="/blog/">Home</a></li>
                    <li class="active"><a href="/blog/archive.html">Archive</a></li>
                    <li class="active"><a href="/blog/categories.html">Categories</a></li>
                    <li class="active"><a href="/blog/tags.html">Tags</a></li>
                    <li class="active"><a href="/blog/about.html">About</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>


<div class="wrap">
    <div class="container container-left">
        <div class="row">
            <div class="col-md-3 hidden-xs">
                
<div class="sidebar well">
    <header class="sidebar-header" role="banner">
        <a href="/blog/">
            <img src="/blog/assets/images/profile.png" style="width: 150px; height: 150px;" class="img-circle" />
        </a>
        <!--
        <h3 class="title">
        <a href="/"></a>
        </h3>
        -->
    </header>
    <div class="text-center">
        Welcome to zxz0！
    </div>
</div>


<div class="sidebar well">
    <h1>Top Posts</h1>
    <ul>
        
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        
    </ul>
</div>


<div class="sidebar well">
    <h1>Recent Posts</h1>
    <ul>
        
          <li><a href="/blog/o&m/2019/12/14/VPS-initialization.html">VPS初始设置</a></li>
        
          <li><a href="/blog/framework/2019/11/13/quartz-framework.html">粗观Quartz调度框架</a></li>
        
          <li><a href="/blog/hardware/2019/11/01/welding-related.html">焊接相关准备知识</a></li>
        
          <li><a href="/blog/network/2019/10/25/home-network-system-related.html">家庭组网相关知识</a></li>
        
          <li><a href="/blog/infrastructure/2019/10/20/rasepberry-pi-server-set-up.html">树莓派从零开始设置记录</a></li>
        
    </ul>
</div>

<div class="sidebar well">
    
<h1>Links</h1>
<ul>
  <!-- <li><a href="#">One</a></li>
  <li><a href="#">Two</a></li>
  <li><a href="#">Three</a></li>
  <li><a href="#">Four</a></li> -->
  
  <li>
    <a href="http://xixia.info">
      Xixia
    </a>
  </li> 
  
  <li>
    <a href="https://github.com/zxixia/jekyll-xixia">
      Jekyll-Xixia
    </a>
  </li> 
  
</ul>

</div>

            </div>
            <div class="col-md-9">
                
<div class="well article">
        <h2><a href="/blog/o&m/2019/12/14/VPS-initialization.html">VPS初始设置</a></h2>
        <span class="post-date">
            
            12/14/2019
        </span>
        <hr style="border-top:1px solid #28323C;"/>
    
    <div class="post-content">
    <p>因为打折，忍不住剁手 * 2。慢慢收拾残局。使用的CloudCone（KVM构架），操作系统CentOS 7.6（<code class="highlighter-rouge">cat /etc/redhat-release 	# CentOS Linux release 7.6.1810 (Core)</code>）。</p>

<ol>
  <li>修改默认的SSH端口22
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> vim /etc/ssh/ssh_config 	<span class="c"># for ssh</span>
 vim /etc/ssh/sshd_config	<span class="c"># for ssh daemon</span>
 <span class="c"># uncomment # Port 22, change 22 to the port you want. better [49152, 65539]</span>
 service sshd restart 		<span class="c"># restart sshd. now can only login thru the specified port</span>
</code></pre></div>    </div>
    <p>通过</p>
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ssh <span class="nt">-p</span> port_you_specified username@ip
</code></pre></div>    </div>
    <p>测试登陆。
如果系统开启了iptables防火墙，还需要设置允许指定的端口。</p>
  </li>
  <li>创建普通用户，给予sudo权限：
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adduser username
passwd username
<span class="c"># need to repeat twice to verify</span>
usermod <span class="nt">-aG</span> wheel username 	<span class="c"># in CentOS, members of wheel group have sudo privileges</span>
<span class="c"># or gpasswd -a username wheel</span>
<span class="c"># su - username to substitute user to check</span>
</code></pre></div>    </div>
    <p>通过切换到用户，sudo测试，如：</p>
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo ls</span> <span class="nt">-la</span> /root
</code></pre></div>    </div>
    <p>session第一次执行sudo需要输入当前用户（非root）密码</p>
  </li>
  <li>限制普通用户的su切换
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> vim /etc/pam.d/su 	
 <span class="c"># uncomment: #auth required pam_wheel.so use_uid, so that only member in wheel group can execute su</span>
</code></pre></div>    </div>
    <p>这样，不属于wheel组的成员账号切换（到root）时，系统会拒绝：即使输入了正确的root密码，也会提示密码不正确</p>
  </li>
  <li>禁止root远程SSH登陆
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/ssh/sshd_config
<span class="c"># change PermitRootLogin yes -&gt; PermitRootLogin no</span>
service sshd restart
</code></pre></div>    </div>
    <p>不影响已连接的SSH。之后需要，可以普通用户远程登录，之后su切换到root；或者sudo执行需要root权限的命令。
往后，我们都使用新建的，有sudo权限的用户进行远程登录，以及各种常规操作。</p>
  </li>
  <li>生成SSH Key pair，UI界面添加公钥到服务器（详见上文：<a href="/blog/practice/2019/09/10/Gitlab-SSH-key.html">GitLab设置SSH key，以及相关知识</a>）
    <ul>
      <li>添加完毕后重新启动，还是不可以使用</li>
      <li>按照页面上的指示，SSH去机器，运行指令：
        <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh root@173.82.151.128 	<span class="c"># connect via SSH. since we disabled root login, we need to login as normal user, then su root</span>
curl <span class="nt">-o</span> cc-ikey <span class="nt">-L</span> web.cloudc.one/sh/key <span class="o">&amp;&amp;</span> sh cc-ikey some_string 	<span class="c"># install the ssh key</span>
</code></pre></div>        </div>
        <p>注意到在CloudCone即使有多个instance/vps，某个vps的UI界面也只有一个SSH Key。要继续添加，可以通过User / SSH Keys. \
仔细查看cc-ikey脚本，发现就是从cloudcone数据库用给定的id拿到UI界面中的public key，放到authorized_keys最后面；根据参数，确定是否关闭root远程登录。由于脚本必须要用root用户，所以无法配置别的用户的SSH key登录。此处使用直接copy到<code class="highlighter-rouge">~/.ssh/authorized_keys</code>的做法，手动添加SSH key到服务器。</p>
      </li>
    </ul>
  </li>
  <li>disable密码登录
    <ul>
      <li>编辑<code class="highlighter-rouge">/etc/ssh/sshd_config</code>文件，加入/置<code class="highlighter-rouge">PasswordAuthentication no</code>，保存</li>
      <li>重启ssh服务：
        <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>service ssh restrat 	<span class="c"># Ubuntu or Debian</span>
<span class="nb">sudo </span>service sshd restart 	<span class="c"># CentOS / Fedora</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>使用/开启防火墙：
CentOS有叫做firewalld的防火墙，工具firewall-cmd可以帮助设置防火墙。基本原则：关闭所有不必要的端口。
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nb">install</span> 	<span class="c"># yum is package management tool. usage: yum install/remove/update/list/search/info/check-update [package_name]</span>
<span class="nb">sudo </span>systemctl start filewalld 	<span class="c"># firewalld can make modification without dropping current connections</span>
<span class="c"># start adjusting policies for the default zone. When we reload out firewall, this will be the zone applied to our interfaces. (NOT TRUE! current normal user connection will freeze and throw "packet_write_wait: Connection to ip_address port ssh_port: Broken pipe" somehow. I opened a root user session, not evicted somehow. maybe need to config this before change default ssh port? next time see if it crash when 2 normal user session are available)</span>
systemctl status firewalld 	<span class="c"># see current firewall status</span>
<span class="nb">sudo </span>firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-service</span><span class="o">=</span>ssh 	<span class="c"># add ssh service. --permanent will save the change to config file</span>
<span class="nb">sudo </span>firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-port</span><span class="o">=</span>valid_port/tcp 	<span class="c"># if the default SSH port (22) changed</span>
<span class="c"># can add other services here, eg. http, https (the corresponding default port will be automatically added)</span>
<span class="nb">sudo </span>firewall-cmd <span class="nt">--permanent</span> <span class="nt">--list-all</span> 	<span class="c"># see config in file</span>
<span class="nb">sudo </span>firewall-cmd <span class="nt">--list-all</span> 	<span class="c"># see current loaded config</span>
<span class="nb">sudo </span>firewall-cmd <span class="nt">--reload</span> 	<span class="c"># reload with new config file, apply the changes</span>
<span class="nb">sudo </span>firewall-cmd <span class="nt">--query-port</span><span class="o">=</span>61187/tcp 	<span class="c"># test the port is open</span>
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>firewalld 	<span class="c"># start firewall at boot</span>
</code></pre></div>    </div>
  </li>
  <li>设置时间同步
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>timedatectl list-timezones 	<span class="c"># to list all. space and b to page down/up, q to exit</span>
<span class="nb">sudo </span>timedatectl set-timezone region/timezone 	<span class="c"># set the right one with server</span>
<span class="nb">sudo </span>timedatectl 	<span class="c"># confirm the updated timezone</span>
<span class="nb">sudo </span>yum <span class="nb">install </span>ntp 	<span class="c"># Network Time Protocol (NTP) synchronization.</span>
<span class="nb">sudo </span>systemctl start ntpd 	<span class="c"># start service for current session</span>
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>ntpd 	<span class="c"># start service at boot</span>
</code></pre></div>    </div>
  </li>
  <li>添加swap file：
当RAM不够的时候，Linux会把释放的空间临时保存到Swap空间中。虚拟内存。如果RAM不够大，或者不想应用crash，就用。尤其推荐db使用。
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>free <span class="nt">-m</span> 	<span class="c"># see how much we have for swap </span>
<span class="nb">sudo </span>fallocate <span class="nt">-l</span> 4G /swapfile 	<span class="c"># can set 1:1 to RAM</span>
<span class="nb">sudo chmod </span>600 /swapfile	<span class="c"># don't let other users to see the content</span>
<span class="nb">sudo </span>mkswap /swapfile 	<span class="c"># tell the system to format the file for swap</span>
<span class="nb">sudo </span>swapon /swapfile 	<span class="c"># tell the system it can use the swap file for current session</span>
<span class="nb">sudo </span>sh <span class="nt">-c</span> <span class="s1">'echo "/swapfile none swap sw 0 0" &gt;&gt; /etc/fstab'</span> 	<span class="c"># modify the system file to do it automatically at boot</span>
</code></pre></div>    </div>
    <hr />
    <h4 id="参考资料">参考资料：</h4>
    <ul>
      <li><a href="https://mp.weixin.qq.com/s/MQqasjPs4Y-OCjQLuFj4ew">手把手教你怎么使用云服务器</a></li>
      <li><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server">How To Configure SSH Key-Based Authentication on a Linux Server</a></li>
      <li><a href="https://stackoverflow.com/questions/10268583/downloading-java-jdk-on-linux-via-wget-is-shown-license-page-instead">Downloading Java JDK on Linux via wget is shown license page instead</a></li>
      <li><a href="https://stackoverflow.com/questions/44213454/not-able-to-install-oracle-jdk-on-centos-machine-using-wget">Not able to install oracle jdk on CentOS machine using wget</a></li>
      <li><a href="https://askubuntu.com/questions/29079/how-do-i-provide-a-username-and-password-to-wget">How do I provide a username and password to wget?</a></li>
      <li><a href="https://blog.csdn.net/luck_zz/article/details/80348592">Linux下载及安装jdk1.8</a></li>
      <li><a href="http://www.linuxfromscratch.org/blfs/view/svn/postlfs/profile.html">The Bash Shell Startup Files</a></li>
      <li><a href="https://stackoverflow.com/questions/10117943/what-is-the-good-way-of-setting-java-home-system-wide-in-linux-etc-profile-or">What is the good way of setting JAVA_HOME system wide in Linux? /etc/profile or /etc/profile.d/custom.sh?</a></li>
      <li><a href="https://juejin.im/post/5ce67fa1f265da1b6a346d16">Java开发环境不再需要配置classpath！</a></li>
      <li><a href="https://blog.csdn.net/tianlesoftware/article/details/6201898">Linux 修改SSH端口 和 禁止Root远程登陆</a></li>
      <li><a href="https://blog.51cto.com/yttitan/1568305">网络安全系列之十三 Linux中su与sudo的安全设置</a></li>
      <li><a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-sudo-user-on-centos-quickstart">How To Create a Sudo User on CentOS [Quickstart]</a></li>
      <li><a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-centos-7">Initial Server Setup with CentOS 7</a></li>
      <li><a href="https://www.digitalocean.com/community/tutorials/additional-recommended-steps-for-new-centos-7-servers">Additional Recommended Steps for New CentOS 7 Servers</a></li>
      <li><a href="https://www.tecmint.com/20-linux-yum-yellowdog-updater-modified-commands-for-package-mangement/">20 Linux YUM (Yellowdog Updater, Modified) Commands for Package Management</a></li>
      <li><a href="https://sebastianblade.com/how-to-modify-ssh-port-in-centos7/">怎样修改 CentOS 7 SSH 端口</a></li>
      <li><a href="https://www.liquidweb.com/kb/an-introduction-to-firewalld/">An Introduction to Firewalld</a></li>
      <li><a href="https://www.cnblogs.com/kerrycode/p/5246383.html">Swap交换分区概念</a></li>
      <li><a href="https://www.cnblogs.com/stulzq/p/9808504.html">Centos7 防火墙 firewalld 实用操作</a></li>
    </ul>
  </li>
</ol>

    <hr style="border-top:1px solid #28323C;"/>

    <!-- tags and categories under post -->
    
    <ul class="list-unstyled list-inline">
      <li><i class="icon-folder-open"></i></li>
      
      
         
            <li class="icon-style"><a href="/blog/categories.html">
                O&M <span>(2)</span>
                
            </a></li>
        
      
    </ul>
      

    
    <ul class="list-unstyled list-inline">
      <li><i class="icon-tags"></i></li>
      
      
         
            <li class="icon-style">
                <a href="/blog/tags.html">
                DevOps <span>(2)</span>
                ,
                </a>
            </li>
         
            <li class="icon-style">
                <a href="/blog/tags.html">
                VPS <span>(1)</span>
                ,
                </a>
            </li>
         
            <li class="icon-style">
                <a href="/blog/tags.html">
                Security <span>(5)</span>
                
                </a>
            </li>
        
      
      
    </ul>
      

    </div>
    
</div>
<div class="pagination">
    
    
    <a class="btn btn-default" href="/blog/framework/2019/11/13/quartz-framework.html" class="previous">Older Post</a>
    
</div>
            </div>
        </div>
    </div>

    
<div class="footer">
    <p>&copy;2019 zxz0 , Powered by
            
                <a href="http://jekyllrb.com/">
                Jekyll
                </a>
                <!-- not the last, output a ',' -->
                
                ,
                
            
                <a href="http://getbootstrap.com/">
                Bootstrap
                </a>
                <!-- not the last, output a ',' -->
                
                ,
                
            
                <a href="https://github.com/">
                Github
                </a>
                <!-- not the last, output a ',' -->
                
                ,
                
            
                <a href="https://github.com/zxixia/jekyll-xixia">
                Xixia
                </a>
                <!-- not the last, output a ',' -->
                
            
    </p>
</div>

<!-- 
    

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', '', 'auto');
    ga('send', 'pageview');
  </script>

 
-->

</body>
</html>

</div>